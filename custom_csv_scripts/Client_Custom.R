# COHHIO_HMIS
# Copyright (C) 2021  Coalition on Homelessness and Housing in Ohio (COHHIO)
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published
# by the Free Software Foundation, either version 3 of the License, or
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU Affero General Public License for more details at
# <https://www.gnu.org/licenses/>.

library(here)
library(tidyverse)
library(readxl)
library(lubridate)

source(here("reading_severance.R"))

# 9 custom fields coming in

sp_question_codes <- c(
  "PERMANENTHOUSINGTRACK",
  "EXPECTEDPERMANENTHOUS",
  "WOULDTHECLIENTCONSENT",
  "IFNOTWHATARETHECONCER",
  "HOMESID",
  "LISTSTATUS",
  "SSVFINELIGIBLE",
  "VAELIGIBLE",
  "DATEVETERANIDENTIFIED"
)

# 5 of them have droplists with Reference Numbers in Clarity

answers_ph_track <- tibble(
  ReferenceNo = c(0:6),
  Value = c("None", "HUD - VASH", "PH", "PSH", "RRH", "Self Resolve", "SSVF-RRH")
)

answers_enhanced_yes_no <- tibble(
  ReferenceNo = c(0, 1, 8, 9, 99),
  Value = c("No (HUD)", "Yes (HUD)", "Client doesn't know (HUD)", 
            "Client refused (HUD)", "Data not collected (HUD)")
)

answers_list_status <- tibble(
  ReferenceNo = c(1:5),
  Value = c("Active - ES/TH",
            "Active - Unsheltered",
            "Inactive (Non-Permanent Housing)",
            "Inactive (Permanently Housed)",
            "Inactive (Uknown/Missing)")
)

answers_ssvf_ineligible <- tibble(
  ReferenceNo = c(1:3),
  Value = c("Max TFA", "Not VA eligible", "Over income")
)

answers_va_eligible <- tibble(
  ReferenceNo = c(1:4),
  Value = c("VA eligibility unknown",
            "Veteran eligible for all VA homeless services",
            "Veteran eligible for SSVF/GPD only",
            "Veteran not eligible for VA services")
)

# gathering them as they are in the data

client_level <- da_answer %>%
  filter(question_code %in% c(sp_question_codes) &
           active == TRUE & client_id %in% c(client_cohort)) %>%
  group_by(client_id, question_code) %>%
  slice_max(date_effective) %>%
  slice_max(date_added) %>%
  ungroup() %>%
  pivot_wider(
    id_cols = c(client_id),
    names_from = question_code,
    values_from = val
  ) %>%
  mutate(
    DATEVETERANIDENTIFIED = format.Date(DATEVETERANIDENTIFIED, "%Y-%m-%d"),
    EXPECTEDPERMANENTHOUS = format.Date(EXPECTEDPERMANENTHOUS, "%Y-%m-%d"),
    ClientCustomID = row_number(),
         ExportID = as.numeric(format.Date(today(), "%Y%m%d"))) %>%
  
  rename(
    "PersonalID" = client_id,
    "c_ph_track" = PERMANENTHOUSINGTRACK,
    "c_expected_ph_date" =	EXPECTEDPERMANENTHOUS,
    "c_covid19_consent_to_vaccine" =	WOULDTHECLIENTCONSENT,
    "c_covid19_vaccine_concerns" =	IFNOTWHATARETHECONCER,
    "c_homes_id" =	HOMESID,
    "c_list_status" =	LISTSTATUS,
    "c_ssvf_ineligible" =	SSVFINELIGIBLE,
    "c_va_eligible" =	VAELIGIBLE,
    "c_date_veteran_identified" =	DATEVETERANIDENTIFIED
  ) %>%
  relocate(ClientCustomID, .before = "PersonalID") %>%
  relocate(ExportID, .after = "PersonalID")

# turning the 5 that need it into their Clarity Reference Numbers

client_custom <- client_level %>%
  left_join(answers_enhanced_yes_no, by = c("c_covid19_consent_to_vaccine" = "Value")) %>%
  mutate(c_covid19_consent_to_vaccine = ReferenceNo,
         ReferenceNo = NULL) %>%
  left_join(answers_list_status, by = c("c_list_status" = "Value")) %>%
  mutate(c_list_status = ReferenceNo,
         ReferenceNo = NULL)  %>%
  left_join(answers_ph_track, by = c("c_ph_track" = "Value")) %>%
  mutate(c_ph_track = ReferenceNo,
         ReferenceNo = NULL)  %>%
  left_join(answers_ssvf_ineligible, by = c("c_ssvf_ineligible" = "Value")) %>%
  mutate(c_ssvf_ineligible = ReferenceNo,
         ReferenceNo = NULL)  %>%
  left_join(answers_va_eligible, by = c("c_va_eligible" = "Value")) %>%
  mutate(c_va_eligible = ReferenceNo,
         ReferenceNo = NULL) 

# Writing it out to csv ---------------------------------------------------

write_csv(client_custom, here("data_to_Clarity/Client_Custom.csv"))

fix_date_times <- function(file) {
  cat(file, sep = "\n")
  x <- read_csv(here(paste0("data_to_Clarity/", file, ".csv")),
                col_types = cols())  %>%
    mutate(
      c_date_veteran_identified = format.Date(c_date_veteran_identified, "%Y-%m-%d"),
      c_expected_ph_date = format.Date(c_expected_ph_date, "%Y-%m-%d")
    )
  
  fwrite(x,
         here(paste0("data_to_Clarity/", file, ".csv")),
         logical01 = TRUE)
}

fix_date_times("Client_Custom")


# DAR checking ------------------------------------------------------------

stray_personalids <- c(
  5,
  4216,
  5725,
  7364,
  10074,
  18957,
  22707,
  24646,
  25339,
  26834,
  30477,
  48499,
  50558,
  50956,
  51730,
  52437,
  54817,
  55920,
  70568,
  76030,
  78921,
  79932,
  81175,
  82137,
  83548,
  84915,
  91746,
  92054,
  92055,
  95878,
  97594,
  97682,
  98476,
  99246,
  105133,
  109949,
  110266,
  112635,
  113254,
  113394,
  113409,
  113559,
  113807,
  115468,
  119696,
  119842,
  121447,
  121448,
  121692,
  121695,
  123810,
  124576,
  124855,
  125988,
  127121,
  128786,
  129832,
  129834,
  131531,
  133588,
  140575,
  140576,
  142248,
  144451,
  144644,
  145394,
  148623,
  149340,
  149342,
  149977,
  150572,
  151494,
  152186,
  152242,
  152243,
  152261,
  155517,
  155522,
  156126,
  157043,
  193789,
  193853,
  202611,
  209887,
  210573,
  210767,
  215471,
  216644,
  217048,
  217607,
  217768,
  219173,
  219716,
  220772,
  220987,
  221186,
  222292,
  222580,
  222711,
  222755,
  223031,
  223409,
  223420,
  223471,
  223570,
  223654,
  223910,
  224310,
  224349,
  224654,
  224833,
  224962,
  224963,
  224964,
  225133,
  225706,
  226043,
  226318,
  226672,
  226945,
  227168,
  227172,
  227769,
  228056,
  228371,
  228510,
  228839,
  228851,
  228874,
  229103,
  229109,
  229233,
  229312,
  229404,
  229440,
  229567,
  229612,
  229626,
  229693,
  229758,
  230070,
  230377,
  230443,
  230475,
  230476,
  230509,
  230637,
  230729,
  230834,
  230921,
  230922,
  231111,
  231112,
  231148,
  231156,
  231175,
  231178,
  231214,
  231261,
  231372,
  231381,
  231496,
  231544,
  231646,
  231673,
  231679,
  231826,
  231827,
  232394,
  232610,
  232721,
  232725,
  232778,
  232958,
  233044,
  233128,
  233237,
  233481,
  233611,
  233725,
  233742,
  233750,
  233793,
  233809,
  234002,
  234185,
  234652,
  234670,
  234903,
  234943,
  235060,
  235106,
  235109,
  235122,
  235138,
  235444,
  235447,
  235450,
  235481,
  235491,
  235506,
  235536,
  235634,
  235651,
  235680,
  235713,
  235733,
  235738,
  235782,
  235807,
  235812,
  235838,
  235866,
  235871,
  235886,
  235914,
  235915,
  235962,
  235969,
  235981,
  235988,
  236013,
  236150,
  236167,
  236175,
  236247,
  236306,
  236333,
  236371,
  236418,
  236475,
  236491,
  236597,
  236598,
  236599,
  236617,
  236621,
  236655,
  236676,
  236716,
  236795,
  236868,
  236882,
  236918,
  236928,
  237000,
  237034,
  237126,
  237177,
  237210,
  237222,
  237225,
  237290,
  237332,
  237357,
  237438,
  237591,
  237636,
  237903,
  237948,
  237953,
  238010,
  238116,
  238146,
  238155,
  238186,
  238238,
  238251,
  238263,
  238266,
  238344,
  238444,
  238554,
  238653,
  238680,
  238819,
  239135,
  239222,
  239224,
  239269,
  239351,
  239359,
  239364,
  239365,
  239435,
  239601,
  239607,
  239749,
  239770,
  239960,
  239984,
  240035,
  240089,
  240100,
  240103,
  240217,
  240378,
  240440,
  240473,
  240481,
  240517,
  240521,
  240614,
  240703,
  240707,
  240737,
  240765,
  240768,
  240824,
  240877,
  240882,
  240964,
  241037,
  241071,
  241119,
  241121,
  241271,
  241320,
  241327,
  241451,
  241572,
  241634,
  241661,
  241709,
  241768,
  241960,
  241997,
  242021,
  242187,
  242230,
  242407,
  242532,
  242705,
  242740,
  242825,
  242916,
  243290,
  243321,
  243379,
  243443,
  243497,
  243500,
  243523,
  243538,
  243585,
  243602,
  243737,
  243844,
  244191,
  244321,
  244561,
  244653,
  244673,
  244735,
  244864,
  245000,
  245099,
  245374,
  245380,
  245381,
  245387,
  245391,
  245399,
  245405,
  245406,
  245408,
  245409,
  245411,
  245413,
  245416,
  245418,
  245419,
  245421,
  245422,
  245423,
  245455,
  245499,
  245503,
  245560,
  245712,
  245823,
  245825,
  245962,
  246049,
  246050,
  246054,
  246058,
  246080,
  246091,
  246106,
  246163,
  246468,
  247115,
  247161,
  247194,
  247477,
  247513,
  247535,
  247718,
  247771,
  247809,
  247849,
  247942,
  248036,
  248074,
  248318,
  248486,
  248589,
  248608,
  248622,
  248647,
  248670,
  248716,
  248742,
  248793,
  248818,
  248835,
  249097,
  249135,
  249318,
  249337,
  249347,
  249361,
  249451,
  249764,
  249852,
  250008,
  250063,
  250073,
  256941,
  275031,
  275072,
  275135,
  275136,
  275186,
  275197,
  275311,
  275352,
  275375,
  275570,
  275833,
  275892,
  275991,
  275992,
  275996,
  276028,
  276160,
  276164,
  276175,
  276184,
  276543,
  276627,
  276722,
  276827,
  276881,
  276961,
  277070,
  277073,
  277092,
  277138,
  277190,
  277307,
  277496,
  277515,
  277516,
  277519,
  277520,
  277521,
  277553,
  277560,
  277561,
  277570,
  277582,
  277644,
  277659,
  277662,
  277665,
  277666,
  277678,
  277715,
  277722,
  277727,
  277728,
  277743,
  277774,
  277776,
  277778,
  277809,
  277825,
  277888,
  277918,
  277935,
  277941,
  277969,
  277970,
  277976,
  278025,
  278027,
  278028,
  278039,
  278048,
  278058,
  278070,
  278082,
  278083,
  278084,
  278085,
  278086,
  278141,
  278147,
  278149,
  278150,
  278151,
  278153,
  278159,
  278161,
  278166,
  278237,
  278238,
  278260,
  278280,
  278300,
  278305,
  278328,
  278329,
  278336,
  278372,
  278375,
  278420,
  278422,
  278423,
  278448,
  278449,
  278450,
  278457,
  278464,
  278466,
  278476,
  278477,
  278478,
  278479,
  278489,
  278497,
  278501,
  278502,
  278504,
  278505,
  278508,
  278509,
  278510,
  278512,
  278513,
  278530,
  278531,
  278543,
  278544,
  278545,
  278546,
  278553,
  278560,
  278561,
  278569,
  278580,
  278581,
  278582,
  278611,
  278620,
  278625,
  278632,
  278642,
  278676,
  278677,
  278682,
  278712,
  278713,
  278717,
  278719,
  278737,
  278741,
  278750,
  278752,
  278771,
  278774,
  278778,
  278779,
  278798,
  278820,
  278836,
  278905,
  278913,
  278920,
  278921,
  278924,
  278925,
  278952,
  278954,
  278971,
  279002,
  279025,
  279026,
  279030,
  279033,
  279050,
  279055,
  279056,
  279069,
  279115,
  279125,
  279138,
  279139,
  279149,
  279155,
  279169,
  279180,
  279226,
  279227,
  279286,
  279333,
  279334,
  279340,
  279352,
  279354,
  279357,
  279358,
  279359,
  279364,
  279365,
  279366,
  279374,
  279375,
  279396,
  279399,
  279400,
  279444,
  279459,
  279460,
  279466,
  279480,
  279485,
  279490,
  279554,
  279558,
  279581,
  279582,
  279590,
  279591,
  279592,
  279617,
  279627,
  279628,
  279636,
  279646,
  279647,
  279648,
  279659,
  279676,
  279681,
  279694,
  279702,
  279714,
  279718,
  279745,
  279786,
  279789,
  279794,
  279819,
  279827,
  279842,
  279843,
  279853,
  279854,
  279900,
  279901,
  279928,
  279929,
  279934,
  279937,
  279946,
  279952,
  279955,
  279960,
  279964,
  279992,
  279995,
  279996,
  280066,
  280086,
  280088,
  280089,
  280090,
  280094,
  280158,
  280160,
  280161,
  280210,
  280211,
  280251,
  280254,
  280261,
  280262,
  280270,
  280273,
  280275,
  280282,
  280288,
  280289,
  280299,
  280328,
  280329,
  280375,
  280380,
  280388,
  280395,
  280449,
  280463,
  280539,
  280540,
  280541,
  280554,
  280555,
  280557,
  280598,
  280601,
  280603,
  280615,
  280617,
  280619,
  280620,
  280621,
  280622,
  280623,
  280624,
  280625,
  280626,
  280627,
  280632,
  280633,
  280634,
  280635,
  280636,
  280637,
  280638,
  280639,
  280640,
  280642,
  280643,
  280644,
  280645,
  280646,
  280647,
  280649,
  280651,
  280652,
  280653,
  280654,
  280655,
  280656,
  280659,
  280660,
  280661,
  280662,
  280667,
  280668,
  280669,
  280670,
  280671,
  280672,
  280674,
  280675,
  280676,
  280677,
  280678,
  280679,
  280680,
  280681,
  280682,
  280683,
  280685,
  280686,
  280687,
  280689,
  280690,
  280691,
  280692,
  280693,
  280694,
  280695,
  280696,
  280698,
  280699,
  280700,
  280701,
  280703,
  280704,
  280705,
  280706,
  280707,
  280708,
  280709,
  280710,
  280711,
  280712,
  280713,
  280714,
  280715,
  280716,
  280717,
  280718,
  280719,
  280724,
  280725,
  280726,
  280728,
  280730,
  280732,
  280733,
  280734,
  280736,
  280737,
  280738,
  280739,
  280740,
  280742,
  280743,
  280744,
  280745,
  280746,
  280747,
  280748,
  280749,
  280750,
  280751,
  280752,
  280753,
  280754,
  280755,
  280756,
  280757,
  280759,
  280760,
  280761,
  280762,
  280764,
  280765,
  280766,
  280767,
  280768,
  280769,
  280770,
  280771,
  280772,
  280773,
  280775,
  280776,
  280778,
  280779,
  280780,
  280781,
  280782,
  280783,
  280784,
  280785,
  280787,
  280788,
  280790,
  280792,
  280793,
  280796,
  280797,
  280799,
  280800,
  280801,
  280802,
  280803,
  280804,
  280805,
  280806,
  280807,
  280811,
  280812,
  280813,
  280819,
  280820,
  280821,
  280822,
  280824,
  280825,
  280826,
  280828,
  280829,
  280830,
  280831,
  280832,
  280833,
  280834,
  280835,
  280836,
  280837,
  280838,
  280839,
  280840,
  280841,
  280842,
  280843,
  280845,
  280846,
  280851,
  280853,
  280854,
  280855,
  280856,
  280857,
  280860,
  280861,
  280862,
  280863,
  280864,
  280865,
  280866,
  280868,
  280869,
  280871,
  280872,
  280873,
  280874,
  280875,
  280876,
  280877,
  280878,
  280882,
  280883,
  280884,
  280885,
  280886,
  280887,
  280888,
  280890,
  280892,
  280894,
  280895,
  280896,
  280897,
  280898,
  280900,
  280902,
  280903,
  280904,
  280906,
  280907,
  280908,
  280909,
  280910,
  280916,
  280917,
  280918,
  280919,
  280920,
  280921,
  280922,
  280924,
  280925,
  280926,
  280927,
  280928,
  280929,
  280931,
  280932,
  280934,
  280939,
  280940,
  280942,
  280943,
  280949,
  280950,
  280951,
  280952,
  280953,
  280954,
  280955,
  280957,
  280958,
  280963,
  280964,
  280965,
  280966,
  280967,
  280968,
  280969,
  280970,
  280971,
  280972,
  280978,
  280979,
  280980,
  280981,
  280982,
  280983,
  280984,
  280985,
  280987,
  280988,
  280989,
  280990,
  280991,
  280992,
  280993,
  280994,
  280995,
  280996,
  280997,
  280998,
  280999,
  281000,
  281001,
  281002,
  281003,
  281004,
  281005,
  281011,
  281015,
  281018,
  281019,
  281020,
  281021,
  281022,
  281023,
  281024,
  281025,
  281030,
  281031,
  281032,
  281033,
  281034,
  281035,
  281036,
  281037,
  281038,
  281039,
  281041,
  281042,
  281043,
  281048,
  281049,
  281052,
  281053,
  281054,
  281063,
  281064,
  281065,
  281066,
  281068,
  281069,
  281070,
  281071,
  281072,
  281073,
  281074,
  281075,
  281076,
  281077,
  281078,
  281079,
  281080,
  281082,
  281084,
  281085,
  281086,
  281089,
  281090,
  281091,
  281092,
  281093,
  281094,
  281095,
  281096,
  281097,
  281099,
  281100,
  281101,
  281102,
  281103,
  281104,
  281105,
  281111,
  281112,
  281114,
  281115,
  281116,
  281117,
  281118,
  281119,
  281120,
  281121,
  281122,
  281123,
  281124,
  281125,
  281126,
  281128,
  281130,
  281131,
  281133,
  281134,
  281135,
  281136,
  281137,
  281139,
  281140,
  281141,
  281143,
  281144,
  281145,
  281146,
  281147,
  281150,
  281151,
  281153,
  281154,
  281155,
  281157,
  281158,
  281161,
  281164,
  281165,
  281166,
  281167,
  281168,
  281169,
  281170,
  281171,
  281172,
  281174,
  281177,
  281179,
  281180,
  281181,
  281184,
  281185,
  281186,
  281187,
  281188,
  281189,
  281197,
  281198,
  281200,
  281205,
  281206,
  281207,
  281208,
  281209,
  281210,
  281212,
  281213,
  281214,
  281215,
  281216,
  281218,
  281219,
  281220,
  281221,
  281222,
  281223,
  281224,
  281228,
  281229,
  281230,
  281233,
  281234,
  281236,
  281237,
  281238,
  281241,
  281242,
  281243,
  281244,
  281246,
  281248,
  281249,
  281250,
  281251,
  281252,
  281253,
  281254,
  281258,
  281266,
  281269,
  281271,
  281272,
  281274,
  281275,
  281277,
  281278,
  281279,
  281280,
  281285,
  281286,
  281288,
  281290,
  281291,
  281293,
  281295,
  281296,
  281297,
  281299,
  281300,
  281301,
  281302,
  281303,
  281304,
  281305,
  281306,
  281307,
  281308,
  281309,
  281310,
  281311,
  281312,
  281313,
  281314,
  281315,
  281316,
  281317,
  281318,
  281319,
  281320,
  281321,
  281327,
  281328,
  281330,
  281331,
  281332,
  281333,
  281334,
  281335,
  281336,
  281337,
  281338,
  281341,
  281342,
  281343,
  281344,
  281345,
  281346,
  281347,
  281349,
  281351,
  281352,
  281353,
  281354,
  281357,
  281359,
  281362,
  281364,
  281366,
  281367,
  281368,
  281369,
  281370,
  281371,
  281372,
  281374,
  281375,
  281376,
  281377,
  281378,
  281379,
  281380,
  281381,
  281382,
  281383,
  281386,
  281387,
  281388,
  281392,
  281393,
  281394,
  281395,
  281396,
  281401,
  281403,
  281404,
  281405,
  281407,
  281408,
  281409,
  281410,
  281411,
  281413,
  281415,
  281424,
  281425,
  281426,
  281427,
  281430,
  281435,
  281436,
  281437,
  281439,
  281440,
  281441,
  281442,
  281443,
  281444,
  281445,
  281446,
  281447,
  281448,
  281449,
  281488,
  282126,
  282127,
  282128,
  282129,
  282133,
  282134,
  282135,
  282136,
  282137,
  282140,
  282143,
  282144,
  282145,
  282146,
  282147,
  282148,
  282149,
  282150,
  282151,
  282157,
  282158,
  282165,
  282166,
  282167,
  282168,
  282169,
  282170,
  282171,
  282172,
  282173,
  282174,
  282176,
  282177,
  282179,
  282180,
  282181,
  282182,
  282183,
  282184,
  282185,
  282194,
  282195,
  282196,
  282197,
  282199,
  282204,
  282205,
  282206,
  282207,
  282209,
  282210,
  282211,
  282212,
  282213,
  282214,
  282215,
  282216,
  282227,
  282228,
  282229,
  282230,
  282234,
  282238,
  282240,
  282241,
  282242,
  282244,
  282245,
  282246,
  282247,
  282248,
  282249,
  282250,
  282251,
  282252,
  282253,
  282254,
  282255,
  282256,
  282257,
  282259,
  282261,
  282262,
  282264,
  282265,
  282266,
  282267,
  282273,
  282274,
  282275,
  282276,
  282280,
  282285,
  282286,
  282292,
  282294,
  282295,
  282297,
  282298,
  282299,
  282300,
  282301,
  282313,
  282316,
  282317,
  282319,
  282320,
  282321,
  282322,
  282323,
  282324,
  282325,
  282326,
  282328,
  282330,
  282333,
  282334,
  282338,
  282341,
  282345,
  282346,
  282351,
  282352,
  282353,
  282354,
  282355,
  282361,
  282362,
  282363,
  282364,
  282365,
  282366,
  282367,
  282369,
  282372,
  282373,
  282374,
  282375,
  282376,
  282377,
  282379,
  282380,
  282381,
  282382,
  282383,
  282384,
  282385,
  282386,
  282387,
  282388,
  282392,
  282401,
  282402,
  282403,
  282406,
  282407,
  282408,
  282410,
  282412,
  282413,
  282414,
  282415,
  282416,
  282417,
  282418,
  282419,
  282420,
  282421,
  282423,
  282424,
  282425,
  282426,
  282427,
  282428,
  282429,
  282430,
  282431,
  282432,
  282433,
  282434,
  282435,
  282437,
  282438,
  282439,
  282440,
  282442,
  282443,
  282444,
  282445,
  282446,
  282447,
  282448,
  282449,
  282450,
  282451,
  282454,
  282456,
  282457,
  282458,
  282459,
  282461,
  282464,
  282465,
  282466,
  282468,
  282469,
  282470,
  282471,
  282474,
  282477,
  282478,
  282479,
  282480,
  282481,
  282482,
  282483,
  282484,
  282485,
  282486,
  282487,
  282489,
  282490,
  282491,
  282493,
  282494
)

why <- intersect(stray_personalids, client_cohort) 

info <- tibble(PersonalID = why) %>%
  left_join(sp_client, by = c("PersonalID" = "client_id")) %>%
  mutate(
    why = case_when(
      ymd_hms(date_added) >= ymd("20210507") ~ "client created after file created"
      )
  )
  
answer_data <- da_answer %>%
  filter(question_code %in% c(sp_question_codes) &
           active == TRUE &
           client_id %in% c(why)) %>%
  group_by(client_id, question_code) %>%
  slice_max(date_effective) %>%
  slice_max(date_added) %>%
  ungroup() %>%
  group_by(client_id) %>%
  summarise(max_value_created_date = max(date_added),
            min_value_created_date = min(date_added)) %>% ungroup() %>%
  mutate(why = if_else(
    max_value_created_date < ymd("20210601") |
      min_value_created_date >= ymd("20210507"), 
    "answers added before or after window", "don't know"
  ))





